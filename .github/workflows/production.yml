name: Production Deployment

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        type: choice
        options:
          - hotfix
          - feature
          - release
        default: feature
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: 'registry.cn-hangzhou.aliyuncs.com'
  DOCKER_NAMESPACE: 'mobilif'
  DEPLOYMENT_SERVER: '8.147.235.48'

jobs:
  # æ£€æŸ¥éƒ¨ç½²è§¦å‘æ¡ä»¶
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      deploy_ref: ${{ steps.check.outputs.deploy_ref }}
    steps:
      - name: Check deployment trigger
        id: check
        run: |
          # æ£€æŸ¥æ˜¯å¦æ˜¯Issueè¯„è®ºè§¦å‘
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            COMMENT="${{ github.event.comment.body }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å°ç¨‹åºæµ‹è¯•ç¡®è®¤
            if [[ "$ISSUE_TITLE" == *"å°ç¨‹åºæµ‹è¯•"* && "$COMMENT" == *"æµ‹è¯•é€šè¿‡"* ]]; then
              echo "âœ… å°ç¨‹åºæµ‹è¯•ç¡®è®¤ï¼Œè§¦å‘ç”Ÿäº§éƒ¨ç½²"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "deploy_ref=main" >> $GITHUB_OUTPUT
            else
              echo "âŒ ä¸æ»¡è¶³éƒ¨ç½²è§¦å‘æ¡ä»¶"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "âœ… æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "deploy_ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªçŸ¥è§¦å‘æ–¹å¼"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # é¢„éƒ¨ç½²æ£€æŸ¥
  pre-deployment-check:
    runs-on: ubuntu-latest
    needs: [check-trigger]
    if: needs.check-trigger.outputs.should_deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.deploy_ref }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Security audit
        run: npm audit --audit-level high
        
      - name: Check environment variables
        run: |
          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          REQUIRED_VARS=("DATABASE_URL" "REDIS_URL" "JWT_SECRET" "DOCKER_PASSWORD")
          for var in "${REQUIRED_VARS[@]}"; do
            if [[ -z "${!var}" && -z "${{ secrets[var] }}" ]]; then
              echo "âŒ Missing required environment variable: $var"
              exit 1
            fi
          done
          echo "âœ… All required environment variables are set"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  # è¿è¡Œç”Ÿäº§å‰æµ‹è¯•
  production-tests:
    runs-on: ubuntu-latest
    needs: [pre-deployment-check]
    if: github.event.inputs.skip_tests != 'true'
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: mobilif_prod_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.deploy_ref }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run critical tests
        env:
          DATABASE_URL: mysql://root:test_password@localhost:3306/mobilif_prod_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: prod_test_jwt_secret
        run: |
          npm run migration:run
          npm run test -- --testPathPattern="critical"
          npm run test:e2e -- --testNamePattern="critical"

  # æ„å»ºDockeré•œåƒ
  build-docker-image:
    runs-on: ubuntu-latest
    needs: [production-tests]
    if: always() && needs.pre-deployment-check.result == 'success' && (needs.production-tests.result == 'success' || needs.production-tests.result == 'skipped')
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.deploy_ref }}
          
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Generate image tag
        id: meta
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=${GITHUB_SHA:0:7}
          IMAGE_TAG="${TIMESTAMP}-${SHORT_SHA}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Generated image tag: $IMAGE_TAG"
          
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/mobilif-backend:${{ steps.meta.outputs.image_tag }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/mobilif-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Save image info
        run: |
          echo "IMAGE_TAG=${{ steps.meta.outputs.image_tag }}" >> deployment-info.txt
          echo "IMAGE_URL=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/mobilif-backend:${{ steps.meta.outputs.image_tag }}" >> deployment-info.txt
          echo "COMMIT_SHA=${{ github.sha }}" >> deployment-info.txt
          echo "DEPLOY_TIME=$(date)" >> deployment-info.txt
          
      - name: Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info.txt
          retention-days: 30

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-to-production:
    runs-on: ubuntu-latest
    needs: [build-docker-image]
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.deploy_ref }}
          
      - name: Download deployment info
        uses: actions/download-artifact@v4
        with:
          name: deployment-info
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOYMENT_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.DEPLOYMENT_SERVER }} >> ~/.ssh/known_hosts
          
      - name: Deploy to server
        run: |
          # è¯»å–éƒ¨ç½²ä¿¡æ¯
          source deployment-info.txt
          
          # è¿æ¥åˆ°æœåŠ¡å™¨å¹¶éƒ¨ç½²
          ssh root@${{ env.DEPLOYMENT_SERVER }} << EOF
            set -e
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² MobiLiF åˆ°ç”Ÿäº§ç¯å¢ƒ..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/mobilif
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -f docker-compose.yml ]; then
              echo "ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
              docker-compose down || true
              tar -czf backup-\$(date +%Y%m%d-%H%M%S).tar.gz . --exclude=backup-*.tar.gz
            fi
            
            # æ›´æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git checkout ${{ needs.check-trigger.outputs.deploy_ref }}
            git pull origin ${{ needs.check-trigger.outputs.deploy_ref }}
            
            # æ›´æ–°Dockeré•œåƒ
            echo "ğŸ³ æ‹‰å–Dockeré•œåƒ..."
            docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/mobilif-backend:$IMAGE_TAG
            
            # æ›´æ–°docker-composeé…ç½®
            echo "âš™ï¸ æ›´æ–°é…ç½®..."
            sed -i "s|image: .*mobilif-backend:.*|image: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/mobilif-backend:$IMAGE_TAG|" docker-compose.yml
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸ”„ å¯åŠ¨æœåŠ¡..."
            docker-compose up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ” å¥åº·æ£€æŸ¥..."
            if curl -f http://localhost:3000/health; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬..."
              docker-compose down
              # è¿™é‡Œå¯ä»¥æ·»åŠ å›æ»šé€»è¾‘
              exit 1
            fi
          EOF
          
      - name: Run database migrations
        run: |
          ssh root@${{ env.DEPLOYMENT_SERVER }} << EOF
            cd /var/www/mobilif
            echo "ğŸ—„ï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
            docker-compose exec -T backend npm run migration:run
          EOF
          
      - name: Verify deployment
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²..."
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          HEALTH_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.DEPLOYMENT_SERVER }}:3000/health)
          if [ "\$HEALTH_STATUS" == "200" ]; then
            echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP \$HEALTH_STATUS)"
            exit 1
          fi
          
          # æ£€æŸ¥APIå¯ç”¨æ€§
          API_STATUS=\$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.DEPLOYMENT_SERVER }}:3000/api/gyms)
          if [ "\$API_STATUS" == "200" ]; then
            echo "âœ… APIç«¯ç‚¹å¯ç”¨"
          else
            echo "âŒ APIç«¯ç‚¹ä¸å¯ç”¨ (HTTP \$API_STATUS)"
            exit 1
          fi

  # éƒ¨ç½²åé€šçŸ¥
  post-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-to-production, build-docker-image]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "# ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## éƒ¨ç½²ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒç‰ˆæœ¬**: ${{ needs.build-docker-image.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²çŠ¶æ€**: ${{ needs.deploy-to-production.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-to-production.result }}" == "success" ]; then
            echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ APIåœ°å€: http://${{ env.DEPLOYMENT_SERVER }}:3000" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“š APIæ–‡æ¡£: http://${{ env.DEPLOYMENT_SERVER }}:3000/api" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ’š å¥åº·æ£€æŸ¥: http://${{ env.DEPLOYMENT_SERVER }}:3000/health" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Update deployment status
        if: needs.deploy-to-production.result == 'success'
        run: |
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
          echo "ğŸ¯ å®Œæ•´çš„å¼€å‘-æµ‹è¯•-éƒ¨ç½²å·¥ä½œæµç¨‹å·²å®Œæˆ"