"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),path_1=tslib_1.__importDefault(require("path")),customError_1=require("../../../../utils/customError"),config_1=require("../../../../config/config"),pluginconfig_1=require("../pluginconfig"),babel7=()=>require("@babel/core"),pluginTransformTypescript=()=>require("@babel/plugin-transform-typescript"),pluginReplaceTsExportAssignment=e=>{const t=e.template("\n    module.exports = ASSIGNMENT;\n  ");return{name:"replace-ts-export-assignment",visitor:{TSExportAssignment(e){e.replaceWith(t({ASSIGNMENT:e.node.expression}))}}}},pluginReplaceTsImportEqualsDeclaration=e=>{const t=e.template("\n    const ID = require(SOURCE);\n  ");return{name:"replace-ts-import-equals-declaration",visitor:{TSImportEqualsDeclaration(e){e.replaceWith(t({ID:e.node.id,SOURCE:e.node.moduleReference.expression}))}}}};function default_1(e){return{name:"summer-typescript",resolveExt:{js:"ts"},workerMethods:{doLoad(e,t,r){let o;try{o=require("@babel/core").transform(e,{babelrc:!1,plugins:[[pluginReplaceTsImportEqualsDeclaration,{}],[pluginReplaceTsExportAssignment,{}],[require("@babel/plugin-transform-typescript"),{}]],sourceFileName:t,sourceMaps:!1,ast:!0,configFile:!1,code:!1})}catch(e){throw(0,customError_1.makeCustomError)(e,customError_1.CustomErrors.SUMMER_PLUGIN_CODE_ERR,t)}return{sourceCode:e,inputMap:r,astInfo:{ast:o.ast,type:config_1.AstType.Babel}}}},async load(t,r){if(!(0,pluginconfig_1.couldUseSWCMode)(e.setting)&&r.endsWith(".ts")){const o=Date.now(),s=path_1.default.relative(e.projectPath,r),i=e.getFile("",s).toString(),n=e.stat("",s),a=await this.runWorkerMethod("doLoad",i,r);return{targetPath:t,source:Object.assign(Object.assign({},a),{mtime:null==n?void 0:n.mtimeMs}),process:[{cost:Date.now()-o,pluginName:"summer-typescript",action:"load"}]}}}}}exports.default=default_1;