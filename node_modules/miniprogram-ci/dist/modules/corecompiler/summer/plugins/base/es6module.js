"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.transformES6ModuleAndGenCode=exports.getBabelRoot=void 0;const config_1=require("../../../../../config/config"),babel_helper_1=require("../../../../../utils/babel_helper"),tools_1=require("../../../../../utils/tools"),pluginTransformModulesCommonjs=()=>require("@babel/plugin-transform-modules-commonjs"),babel7=()=>require("@babel/core");function getES6ModulePluginsList(e){return[[require("@babel/plugin-transform-modules-commonjs"),{allowTopLevelThis:e,importInterop:e=>e.startsWith("@babel/runtime/helpers/")?"node":"babel"}]]}function getBabelRoot(e){return""===e?"@babel/runtime":(0,tools_1.normalizePath)(e+"/@babel/runtime")}function transformES6ModuleAndGenCode(e,o,t){const r=t.disableUseStrict||/^\s*\/\/\s?use strict disable;/i.test(o.sourceCode||"");let s;try{const t={babelrc:!1,plugins:getES6ModulePluginsList(r),filename:e,sourceFileName:e,sourceMaps:!0,inputSourceMap:o.inputMap,configFile:!1,code:!0,cloneInputAst:!0},n=require("@babel/core");if(!o.astInfo)throw new Error("source.astInfo is not exist");if(o.astInfo.type!==config_1.AstType.Babel)throw new Error("ast type is not babel");s=n.transformFromAstSync(o.astInfo.ast,o.sourceCode,t)}catch(o){throw o.code=config_1.BABEL_TRANS_JS_ERR,o.message=`file: ${e}\n ${o.message}`,o.path=e,o}if(!s)throw new Error("no trans result for callPostEnhance");let n=s.code;const a=s.map;r&&(n=n.replace(/^"use strict";/,""));const l=(0,babel_helper_1.collectBabelHelpers)(o.sourceCode),i=(0,babel_helper_1.replaceBabelHelpers)(n,l,e,t.babelRoot);return{code:i.transformCode,map:a,helpers:i.helpers}}function default_1(e,o){return{name:"summer-es6module",workerMethods:{async doGenerate(e,o,t){const r=await transformES6ModuleAndGenCode(e,o,t);return Object.assign(Object.assign({},r),{resultType:t.resultType})}},async generate(e,t,r,{independentRoot:s,isBabelIgnore:n,resultType:a}){const l=Date.now(),{source:i}=e;if(t.endsWith(".js")&&!i.largeFile&&!n){if(!i.astInfo){if(null===i.sourceCode)throw new Error("source.sourceCode is null");return Object.assign(Object.assign({},e),{target:{code:i.sourceCode,map:i.inputMap,helpers:[],resultType:a||"prod"},process:[...e.process,{cost:Date.now()-l,pluginName:"summer-es6module",action:"generate"}]})}const t={babelRoot:getBabelRoot(s),disableUseStrict:o.disableUseStrict,resultType:a},n=await this.runWorkerMethod("doGenerate",r,i,t);return Object.assign(Object.assign({},e),{target:n,process:[...e.process,{cost:Date.now()-l,pluginName:"summer-es6module",action:"generate",options:t}]})}}}}exports.getBabelRoot=getBabelRoot,exports.transformES6ModuleAndGenCode=transformES6ModuleAndGenCode,exports.default=default_1;