"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSONConditionCompiler=void 0;const tslib_1=require("tslib"),lodash_1=tslib_1.__importDefault(require("lodash")),define_1=require("../../../../config/define"),config_1=require("../../../../config/config"),common_1=require("../../../../utils/common"),tools_1=require("../../../../utils/tools"),base_1=require("./base");class JSONConditionCompiler extends base_1.BaseConditionCompiler{doCompile(e){const{filePath:o,content:i,macroDefine:r}=e,t=i.toString();t||(0,common_1.throwError)({filePath:o,msg:"Empty file is NOT a valid json file",code:config_1.JSON_PARSE_ERR});const s=r.getDefines(),n=Object.values(define_1.PLATFORM),a=s.PLATFORM;let c={};try{c=JSON.parse(t)}catch(e){const i=(0,tools_1.formatJSONParseErr)({filePath:o,data:t,error:e});(0,common_1.throwError)({filePath:o,msg:i,code:config_1.JSON_PARSE_ERR})}const l=c[a]||("mini-weixin"===a?c["mini-wechat"]:{})||{};n.forEach(e=>{c[e]&&delete c[e]});const f=c.subPackages||c.subpackages,d=l.subPackages||l.subpackages;if(Array.isArray(f)&&Array.isArray(d)){for(const e in d){const o=d[e].root,i=d[e].pages;if(o&&i){const r=f.find(e=>e.root===o);r?(r.pages=[...new Set([...r.pages,...i])],r.name=d[e].name):f.push(d[e])}}return delete l.subPackages,delete l.subpackages,JSON.stringify(lodash_1.default.merge(c,l))}return JSON.stringify(lodash_1.default.merge(c,l))}}exports.JSONConditionCompiler=JSONConditionCompiler;