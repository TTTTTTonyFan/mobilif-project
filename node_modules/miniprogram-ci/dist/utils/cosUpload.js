"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.uploadToCosInCI=exports.uploadToCosCore=void 0;const COS=require("cos-js-sdk-v5"),COSForNode=require("cos-nodejs-sdk-v5"),fs=require("fs");function compareCache(e,o){const t=Object.keys(o);for(const r of Object.keys(e)){if(!t.includes(r))return!1;if(o[r]!=e[r])return!1}return!0}async function uploadToCosCore({uploadBuf:e,region:o,getUploadInfoFunc:t,getAuthFunc:r}){return new Promise((n,i)=>{t().then(t=>{let u=null;const s="undefined"==typeof Blob||"undefined"==typeof XMLHttpRequest,c=new(s?COSForNode:COS)({getAuthorization(e,o){var n;if(1!=e.Scope.length)return void o("");const i=Object.assign({},t,{action:e.Scope[0].action});(null===(n=e.Query)||void 0===n?void 0:n.uploadId)&&(i.uploadId=e.Query.uploadId),null!==u&&compareCache(i,u)&&u.AuthExpireTime>Math.round(Date.now()/1e3)?o({Authorization:u.Authorization,SecurityToken:u.SecurityToken,SignFrom:"client"}):r(i).then(e=>{u=Object.assign({},i,{Authorization:e.Authorization,SecurityToken:e.SecurityToken,SignFrom:"client",AuthExpireTime:e.AuthExpireTime}),o({Authorization:e.Authorization,SecurityToken:e.SecurityToken,SignFrom:"client"})},()=>{o("")})}});let l=void 0,a={};if(s)try{const o=require("tmp");o.setGracefulCleanup(),a=o.fileSync({mode:420,prefix:"",postfix:""}),fs.writeSync(a.fd,e,0,e.length,null),fs.closeSync(a.fd)}catch(e){throw console.error("Error:",e),new Error("[upload Cos failed] write compileresult to tmp file failed: "+e.message)}else l=new Blob([e],{type:"application/octet-stream"});c.sliceUploadFile({Bucket:t.bucket,Region:o,Key:t.object,Body:l,FilePath:a.name,SliceSize:5242880,onProgress(){},AsyncLimit:1},(e,o)=>{e?i({err:e,data:o}):n({err:e,data:o})})},e=>{i({err:e})})})}function uploadToCosInCI(){}exports.uploadToCosCore=uploadToCosCore,exports.uploadToCosInCI=uploadToCosInCI;