# MobiLiF拓练 数据库设计文档

## 1. 数据库设计概述

### 1.1 设计原则
- **规范化设计**: 遵循数据库三范式，避免数据冗余
- **性能优先**: 合理使用索引，优化查询性能
- **扩展性**: 预留字段，支持业务快速迭代
- **安全性**: 敏感数据加密，访问权限控制
- **国际化**: 支持多语言，考虑多时区

### 1.2 数据库选型
- **主数据库**: MySQL 8.0（InnoDB引擎）
- **缓存数据库**: Redis 7.0
- **NoSQL数据库**: MongoDB 6.0
- **时序数据库**: InfluxDB 2.0
- **搜索引擎**: Elasticsearch 8.0

## 2. 数据库架构设计

### 2.1 数据库拆分策略

```
mobilif_user        # 用户相关数据库
mobilif_gym         # 场馆相关数据库  
mobilif_order       # 订单相关数据库
mobilif_game        # 游戏化相关数据库
mobilif_social      # 社交相关数据库
mobilif_content     # 内容相关数据库
mobilif_analytics   # 数据分析数据库
```

### 2.2 主从架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Master    │────▶│   Slave 1   │────▶│   Slave 2   │
│  (Write)    │     │   (Read)    │     │   (Read)    │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 3. 核心数据表设计

### 3.1 用户模块（mobilif_user）

#### 3.1.1 用户基础表

```sql
-- 用户主表
CREATE TABLE `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `username` VARCHAR(50) DEFAULT NULL COMMENT '用户名',
  `nickname` VARCHAR(50) NOT NULL COMMENT '昵称',
  `avatar_url` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
  `gender` ENUM('male','female','other') DEFAULT NULL COMMENT '性别',
  `birth_date` DATE DEFAULT NULL COMMENT '出生日期',
  `country_code` VARCHAR(10) DEFAULT 'CN' COMMENT '国家代码',
  `city` VARCHAR(100) DEFAULT NULL COMMENT '城市',
  `bio` VARCHAR(500) DEFAULT NULL COMMENT '个人简介',
  `language` VARCHAR(10) DEFAULT 'zh-CN' COMMENT '语言偏好',
  `timezone` VARCHAR(50) DEFAULT 'Asia/Shanghai' COMMENT '时区',
  `status` ENUM('active','inactive','banned','deleted') NOT NULL DEFAULT 'active' COMMENT '状态',
  `last_login_at` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(45) DEFAULT NULL COMMENT '最后登录IP',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_city` (`city`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户主表';

-- 用户认证表
CREATE TABLE `user_auth` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '认证ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `auth_type` ENUM('password','wechat','apple','google','facebook') NOT NULL COMMENT '认证类型',
  `identifier` VARCHAR(200) NOT NULL COMMENT '标识（手机号/邮箱/第三方ID）',
  `credential` VARCHAR(500) DEFAULT NULL COMMENT '凭证（密码/token）',
  `verified` TINYINT(1) NOT NULL DEFAULT '0' COMMENT '是否验证',
  `last_used_at` DATETIME DEFAULT NULL COMMENT '最后使用时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_auth_identifier` (`auth_type`,`identifier`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_user_auth_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户认证表';

-- 用户设备表
CREATE TABLE `user_devices` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '设备ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `device_id` VARCHAR(100) NOT NULL COMMENT '设备唯一标识',
  `device_type` ENUM('ios','android','web') NOT NULL COMMENT '设备类型',
  `device_name` VARCHAR(100) DEFAULT NULL COMMENT '设备名称',
  `device_model` VARCHAR(100) DEFAULT NULL COMMENT '设备型号',
  `os_version` VARCHAR(50) DEFAULT NULL COMMENT '操作系统版本',
  `app_version` VARCHAR(50) DEFAULT NULL COMMENT 'APP版本',
  `push_token` VARCHAR(500) DEFAULT NULL COMMENT '推送Token',
  `last_active_at` DATETIME DEFAULT NULL COMMENT '最后活跃时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_device_id` (`device_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_last_active` (`last_active_at`),
  CONSTRAINT `fk_user_device_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户设备表';

-- 用户运动档案表
CREATE TABLE `user_fitness_profiles` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '档案ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `crossfit_experience_months` INT DEFAULT '0' COMMENT 'CrossFit经验(月)',
  `skill_level` ENUM('beginner','intermediate','advanced','expert') DEFAULT 'beginner' COMMENT '技能等级',
  `training_frequency` INT DEFAULT '0' COMMENT '每周训练次数',
  `training_goals` JSON DEFAULT NULL COMMENT '训练目标',
  `height_cm` DECIMAL(5,2) DEFAULT NULL COMMENT '身高(cm)',
  `weight_kg` DECIMAL(5,2) DEFAULT NULL COMMENT '体重(kg)',
  `body_fat_percentage` DECIMAL(4,2) DEFAULT NULL COMMENT '体脂率(%)',
  `muscle_mass_kg` DECIMAL(5,2) DEFAULT NULL COMMENT '肌肉量(kg)',
  `pr_records` JSON DEFAULT NULL COMMENT 'PR记录',
  `injuries` JSON DEFAULT NULL COMMENT '伤病史',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_skill_level` (`skill_level`),
  CONSTRAINT `fk_fitness_profile_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户运动档案表';

-- 用户隐私设置表
CREATE TABLE `user_privacy_settings` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '设置ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `profile_visibility` ENUM('public','friends','private') DEFAULT 'public' COMMENT '资料可见性',
  `workout_visibility` ENUM('public','friends','private') DEFAULT 'friends' COMMENT '训练记录可见性',
  `location_visibility` ENUM('public','friends','private') DEFAULT 'friends' COMMENT '位置可见性',
  `allow_friend_requests` TINYINT(1) DEFAULT '1' COMMENT '允许好友请求',
  `allow_messages` ENUM('all','friends','none') DEFAULT 'friends' COMMENT '消息接收设置',
  `allow_notifications` TINYINT(1) DEFAULT '1' COMMENT '允许推送通知',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  CONSTRAINT `fk_privacy_settings_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户隐私设置表';
```

### 3.2 场馆模块（mobilif_gym）

#### 3.2.1 场馆相关表

```sql
-- 场馆表
CREATE TABLE `gyms` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '场馆ID',
  `name` VARCHAR(100) NOT NULL COMMENT '场馆名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '场馆英文名',
  `brand_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '品牌ID',
  `description` TEXT COMMENT '场馆描述',
  `description_en` TEXT COMMENT '英文描述',
  `cover_image` VARCHAR(500) DEFAULT NULL COMMENT '封面图',
  `images` JSON DEFAULT NULL COMMENT '场馆图片集',
  `address` VARCHAR(500) NOT NULL COMMENT '详细地址',
  `latitude` DECIMAL(10,8) NOT NULL COMMENT '纬度',
  `longitude` DECIMAL(11,8) NOT NULL COMMENT '经度',
  `geohash` VARCHAR(20) DEFAULT NULL COMMENT 'Geohash编码',
  `country_code` VARCHAR(10) NOT NULL DEFAULT 'CN' COMMENT '国家代码',
  `province` VARCHAR(50) DEFAULT NULL COMMENT '省份',
  `city` VARCHAR(50) NOT NULL COMMENT '城市',
  `district` VARCHAR(50) DEFAULT NULL COMMENT '区域',
  `phone` VARCHAR(50) DEFAULT NULL COMMENT '联系电话',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `website` VARCHAR(200) DEFAULT NULL COMMENT '网站',
  `wechat` VARCHAR(50) DEFAULT NULL COMMENT '微信号',
  `business_hours` JSON DEFAULT NULL COMMENT '营业时间',
  `facilities` JSON DEFAULT NULL COMMENT '设施设备',
  `services` JSON DEFAULT NULL COMMENT '服务项目',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `parking_info` VARCHAR(200) DEFAULT NULL COMMENT '停车信息',
  `rating` DECIMAL(2,1) DEFAULT '0.0' COMMENT '评分',
  `rating_count` INT DEFAULT '0' COMMENT '评价数',
  `price_range` VARCHAR(50) DEFAULT NULL COMMENT '价格区间',
  `trial_price` DECIMAL(10,2) DEFAULT NULL COMMENT '体验价格',
  `status` ENUM('active','inactive','pending','closed') DEFAULT 'pending' COMMENT '状态',
  `verified` TINYINT(1) DEFAULT '0' COMMENT '是否认证',
  `verified_at` DATETIME DEFAULT NULL COMMENT '认证时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_location` (`latitude`,`longitude`),
  KEY `idx_geohash` (`geohash`),
  KEY `idx_city_status` (`city`,`status`),
  KEY `idx_rating` (`rating`),
  KEY `idx_brand` (`brand_id`),
  FULLTEXT KEY `ft_name` (`name`,`name_en`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='场馆表';

-- 场馆管理员表
CREATE TABLE `gym_admins` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '管理员ID',
  `gym_id` BIGINT UNSIGNED NOT NULL COMMENT '场馆ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `role` ENUM('owner','manager','staff') NOT NULL DEFAULT 'staff' COMMENT '角色',
  `permissions` JSON DEFAULT NULL COMMENT '权限设置',
  `status` ENUM('active','inactive') DEFAULT 'active' COMMENT '状态',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_gym_user` (`gym_id`,`user_id`),
  KEY `idx_user_id` (`user_id`),
  CONSTRAINT `fk_gym_admin_gym` FOREIGN KEY (`gym_id`) REFERENCES `gyms` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='场馆管理员表';

-- 教练表
CREATE TABLE `coaches` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '教练ID',
  `user_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联用户ID',
  `gym_id` BIGINT UNSIGNED NOT NULL COMMENT '所属场馆ID',
  `name` VARCHAR(50) NOT NULL COMMENT '教练姓名',
  `name_en` VARCHAR(50) DEFAULT NULL COMMENT '英文名',
  `avatar_url` VARCHAR(500) DEFAULT NULL COMMENT '头像',
  `gender` ENUM('male','female') DEFAULT NULL COMMENT '性别',
  `bio` TEXT COMMENT '个人简介',
  `bio_en` TEXT COMMENT '英文简介',
  `certifications` JSON DEFAULT NULL COMMENT '资质证书',
  `specialties` JSON DEFAULT NULL COMMENT '专长领域',
  `experience_years` INT DEFAULT '0' COMMENT '从业年限',
  `education` VARCHAR(200) DEFAULT NULL COMMENT '教育背景',
  `achievements` JSON DEFAULT NULL COMMENT '成就荣誉',
  `languages` JSON DEFAULT NULL COMMENT '语言能力',
  `rating` DECIMAL(2,1) DEFAULT '0.0' COMMENT '评分',
  `rating_count` INT DEFAULT '0' COMMENT '评价数',
  `class_count` INT DEFAULT '0' COMMENT '授课次数',
  `status` ENUM('active','inactive','vacation') DEFAULT 'active' COMMENT '状态',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_gym_id` (`gym_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_rating` (`rating`),
  CONSTRAINT `fk_coach_gym` FOREIGN KEY (`gym_id`) REFERENCES `gyms` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='教练表';

-- 课程表
CREATE TABLE `classes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '课程ID',
  `gym_id` BIGINT UNSIGNED NOT NULL COMMENT '场馆ID',
  `coach_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '教练ID',
  `name` VARCHAR(100) NOT NULL COMMENT '课程名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '英文名称',
  `type` ENUM('wod','weightlifting','gymnastics','conditioning','mobility','beginner','private','team') NOT NULL COMMENT '课程类型',
  `description` TEXT COMMENT '课程描述',
  `wod_content` TEXT COMMENT 'WOD内容',
  `difficulty_level` ENUM('beginner','intermediate','advanced','rx','rx+') DEFAULT 'intermediate' COMMENT '难度等级',
  `start_time` DATETIME NOT NULL COMMENT '开始时间',
  `end_time` DATETIME NOT NULL COMMENT '结束时间',
  `duration_minutes` INT NOT NULL DEFAULT '60' COMMENT '时长(分钟)',
  `max_capacity` INT NOT NULL DEFAULT '20' COMMENT '最大人数',
  `min_capacity` INT DEFAULT '1' COMMENT '最小开课人数',
  `current_bookings` INT DEFAULT '0' COMMENT '当前预约数',
  `waitlist_count` INT DEFAULT '0' COMMENT '候补人数',
  `price` DECIMAL(10,2) NOT NULL COMMENT '价格',
  `member_price` DECIMAL(10,2) DEFAULT NULL COMMENT '会员价',
  `drop_in_price` DECIMAL(10,2) DEFAULT NULL COMMENT 'Drop-in价格',
  `equipment_needed` JSON DEFAULT NULL COMMENT '所需器械',
  `prerequisites` JSON DEFAULT NULL COMMENT '先修要求',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `status` ENUM('scheduled','ongoing','completed','cancelled') DEFAULT 'scheduled' COMMENT '状态',
  `cancel_reason` VARCHAR(200) DEFAULT NULL COMMENT '取消原因',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_gym_time` (`gym_id`,`start_time`),
  KEY `idx_coach_id` (`coach_id`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_start_time` (`start_time`),
  CONSTRAINT `fk_class_gym` FOREIGN KEY (`gym_id`) REFERENCES `gyms` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_class_coach` FOREIGN KEY (`coach_id`) REFERENCES `coaches` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程表';

-- 课程模板表（用于重复课程）
CREATE TABLE `class_templates` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `gym_id` BIGINT UNSIGNED NOT NULL COMMENT '场馆ID',
  `name` VARCHAR(100) NOT NULL COMMENT '模板名称',
  `type` ENUM('wod','weightlifting','gymnastics','conditioning','mobility','beginner','private','team') NOT NULL COMMENT '课程类型',
  `description` TEXT COMMENT '课程描述',
  `coach_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '默认教练',
  `duration_minutes` INT DEFAULT '60' COMMENT '时长',
  `max_capacity` INT DEFAULT '20' COMMENT '最大人数',
  `price` DECIMAL(10,2) NOT NULL COMMENT '价格',
  `recurrence_rule` JSON DEFAULT NULL COMMENT '重复规则',
  `is_active` TINYINT(1) DEFAULT '1' COMMENT '是否启用',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_gym_id` (`gym_id`),
  CONSTRAINT `fk_template_gym` FOREIGN KEY (`gym_id`) REFERENCES `gyms` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程模板表';
```

### 3.3 订单模块（mobilif_order）

#### 3.3.1 订单相关表

```sql
-- 预约订单表
CREATE TABLE `bookings` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '预约ID',
  `booking_no` VARCHAR(32) NOT NULL COMMENT '预约编号',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `class_id` BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
  `gym_id` BIGINT UNSIGNED NOT NULL COMMENT '场馆ID',
  `coach_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '教练ID',
  `type` ENUM('regular','trial','drop_in','package') DEFAULT 'regular' COMMENT '预约类型',
  `source` ENUM('app','web','wechat','admin') DEFAULT 'app' COMMENT '预约来源',
  `status` ENUM('pending','confirmed','waitlist','cancelled','completed','no_show','refunded') DEFAULT 'pending' COMMENT '预约状态',
  `payment_status` ENUM('unpaid','paid','refunded','partial_refund') DEFAULT 'unpaid' COMMENT '支付状态',
  `amount` DECIMAL(10,2) NOT NULL COMMENT '应付金额',
  `discount_amount` DECIMAL(10,2) DEFAULT '0.00' COMMENT '优惠金额',
  `points_used` INT DEFAULT '0' COMMENT '使用积分',
  `points_deducted` DECIMAL(10,2) DEFAULT '0.00' COMMENT '积分抵扣金额',
  `coupon_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '优惠券ID',
  `coupon_deducted` DECIMAL(10,2) DEFAULT '0.00' COMMENT '优惠券抵扣',
  `final_amount` DECIMAL(10,2) NOT NULL COMMENT '实付金额',
  `payment_method` VARCHAR(50) DEFAULT NULL COMMENT '支付方式',
  `payment_time` DATETIME DEFAULT NULL COMMENT '支付时间',
  `transaction_no` VARCHAR(64) DEFAULT NULL COMMENT '支付流水号',
  `check_in_time` DATETIME DEFAULT NULL COMMENT '签到时间',
  `check_in_method` ENUM('qrcode','manual','auto') DEFAULT NULL COMMENT '签到方式',
  `check_out_time` DATETIME DEFAULT NULL COMMENT '签退时间',
  `special_requests` TEXT COMMENT '特殊要求',
  `cancel_time` DATETIME DEFAULT NULL COMMENT '取消时间',
  `cancel_reason` VARCHAR(200) DEFAULT NULL COMMENT '取消原因',
  `refund_amount` DECIMAL(10,2) DEFAULT NULL COMMENT '退款金额',
  `refund_time` DATETIME DEFAULT NULL COMMENT '退款时间',
  `rating` INT DEFAULT NULL COMMENT '评分(1-5)',
  `review` TEXT COMMENT '评价内容',
  `review_time` DATETIME DEFAULT NULL COMMENT '评价时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_booking_no` (`booking_no`),
  KEY `idx_user_status` (`user_id`,`status`),
  KEY `idx_class_id` (`class_id`),
  KEY `idx_gym_id` (`gym_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_payment_status` (`payment_status`),
  KEY `idx_check_in_time` (`check_in_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='预约订单表';

-- 候补列表表
CREATE TABLE `waitlists` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '候补ID',
  `class_id` BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `position` INT NOT NULL COMMENT '候补位置',
  `status` ENUM('waiting','converted','expired','cancelled') DEFAULT 'waiting' COMMENT '状态',
  `converted_booking_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '转换的预约ID',
  `expired_at` DATETIME DEFAULT NULL COMMENT '过期时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_class_user` (`class_id`,`user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_waitlist_class` FOREIGN KEY (`class_id`) REFERENCES `classes` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='候补列表表';

-- 支付记录表
CREATE TABLE `payment_records` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '支付记录ID',
  `payment_no` VARCHAR(64) NOT NULL COMMENT '支付单号',
  `transaction_no` VARCHAR(64) DEFAULT NULL COMMENT '第三方流水号',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `order_type` ENUM('booking','membership','package','points','other') NOT NULL COMMENT '订单类型',
  `order_id` BIGINT UNSIGNED NOT NULL COMMENT '订单ID',
  `amount` DECIMAL(10,2) NOT NULL COMMENT '支付金额',
  `currency` VARCHAR(3) DEFAULT 'CNY' COMMENT '货币类型',
  `payment_method` ENUM('wechat','alipay','card','balance','points','cash') NOT NULL COMMENT '支付方式',
  `channel` VARCHAR(50) DEFAULT NULL COMMENT '支付渠道',
  `status` ENUM('pending','processing','success','failed','cancelled','timeout') DEFAULT 'pending' COMMENT '支付状态',
  `gateway_response` JSON DEFAULT NULL COMMENT '网关响应',
  `paid_at` DATETIME DEFAULT NULL COMMENT '支付时间',
  `failure_reason` VARCHAR(200) DEFAULT NULL COMMENT '失败原因',
  `refund_status` ENUM('none','partial','full') DEFAULT 'none' COMMENT '退款状态',
  `refund_amount` DECIMAL(10,2) DEFAULT '0.00' COMMENT '退款金额',
  `device_info` JSON DEFAULT NULL COMMENT '设备信息',
  `ip_address` VARCHAR(45) DEFAULT NULL COMMENT 'IP地址',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_payment_no` (`payment_no`),
  KEY `idx_transaction_no` (`transaction_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_order` (`order_type`,`order_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='支付记录表';

-- 退款记录表
CREATE TABLE `refund_records` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '退款记录ID',
  `refund_no` VARCHAR(64) NOT NULL COMMENT '退款单号',
  `payment_id` BIGINT UNSIGNED NOT NULL COMMENT '原支付ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `amount` DECIMAL(10,2) NOT NULL COMMENT '退款金额',
  `reason` VARCHAR(200) NOT NULL COMMENT '退款原因',
  `type` ENUM('user_cancel','gym_cancel','system_cancel','cs_process') NOT NULL COMMENT '退款类型',
  `status` ENUM('pending','processing','success','failed','rejected') DEFAULT 'pending' COMMENT '退款状态',
  `channel_refund_no` VARCHAR(64) DEFAULT NULL COMMENT '渠道退款单号',
  `processed_at` DATETIME DEFAULT NULL COMMENT '处理时间',
  `completed_at` DATETIME DEFAULT NULL COMMENT '完成时间',
  `operator_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '操作人ID',
  `remark` TEXT COMMENT '备注',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_refund_no` (`refund_no`),
  KEY `idx_payment_id` (`payment_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_refund_payment` FOREIGN KEY (`payment_id`) REFERENCES `payment_records` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='退款记录表';
```

### 3.4 游戏化模块（mobilif_game）

#### 3.4.1 积分体系表

```sql
-- 用户积分表
CREATE TABLE `user_points` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '积分ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `current_points` INT NOT NULL DEFAULT '0' COMMENT '当前积分',
  `total_earned` INT NOT NULL DEFAULT '0' COMMENT '累计获得',
  `total_spent` INT NOT NULL DEFAULT '0' COMMENT '累计消费',
  `frozen_points` INT NOT NULL DEFAULT '0' COMMENT '冻结积分',
  `level` ENUM('bronze','silver','gold','platinum','diamond') DEFAULT 'bronze' COMMENT '会员等级',
  `level_points` INT NOT NULL DEFAULT '0' COMMENT '等级积分',
  `next_level_points` INT NOT NULL DEFAULT '500' COMMENT '下一等级所需',
  `expire_notice_sent` TINYINT(1) DEFAULT '0' COMMENT '过期提醒已发送',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_level` (`level`),
  KEY `idx_current_points` (`current_points`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户积分表';

-- 积分流水表
CREATE TABLE `point_transactions` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '流水ID',
  `transaction_no` VARCHAR(32) NOT NULL COMMENT '流水号',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `type` ENUM('earn','spend','expire','adjust') NOT NULL COMMENT '类型',
  `amount` INT NOT NULL COMMENT '积分数量',
  `balance_before` INT NOT NULL COMMENT '变动前余额',
  `balance_after` INT NOT NULL COMMENT '变动后余额',
  `source` VARCHAR(50) NOT NULL COMMENT '来源',
  `source_id` VARCHAR(64) DEFAULT NULL COMMENT '来源ID',
  `description` VARCHAR(200) NOT NULL COMMENT '描述',
  `expire_at` DATE DEFAULT NULL COMMENT '过期时间',
  `operator_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '操作人',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_transaction_no` (`transaction_no`),
  KEY `idx_user_type` (`user_id`,`type`),
  KEY `idx_source` (`source`,`source_id`),
  KEY `idx_expire_at` (`expire_at`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='积分流水表';

-- 积分规则表
CREATE TABLE `point_rules` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '规则ID',
  `code` VARCHAR(50) NOT NULL COMMENT '规则代码',
  `name` VARCHAR(100) NOT NULL COMMENT '规则名称',
  `type` ENUM('earn','spend') NOT NULL COMMENT '规则类型',
  `category` VARCHAR(50) NOT NULL COMMENT '分类',
  `points` INT NOT NULL COMMENT '积分值',
  `conditions` JSON DEFAULT NULL COMMENT '条件配置',
  `daily_limit` INT DEFAULT NULL COMMENT '每日限制',
  `total_limit` INT DEFAULT NULL COMMENT '总限制',
  `start_time` DATETIME DEFAULT NULL COMMENT '开始时间',
  `end_time` DATETIME DEFAULT NULL COMMENT '结束时间',
  `is_active` TINYINT(1) DEFAULT '1' COMMENT '是否启用',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_type_category` (`type`,`category`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='积分规则表';
```

#### 3.4.2 成就系统表

```sql
-- 成就定义表
CREATE TABLE `achievements` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '成就ID',
  `code` VARCHAR(50) NOT NULL COMMENT '成就代码',
  `name` VARCHAR(100) NOT NULL COMMENT '成就名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '英文名称',
  `description` TEXT COMMENT '成就描述',
  `description_en` TEXT COMMENT '英文描述',
  `category` ENUM('training','skill','social','special','milestone') NOT NULL COMMENT '成就类别',
  `type` ENUM('badge','milestone','title') NOT NULL COMMENT '成就类型',
  `level` INT DEFAULT '1' COMMENT '成就等级',
  `icon_url` VARCHAR(500) DEFAULT NULL COMMENT '图标URL',
  `bg_image_url` VARCHAR(500) DEFAULT NULL COMMENT '背景图URL',
  `points_reward` INT DEFAULT '0' COMMENT '积分奖励',
  `requirements` JSON NOT NULL COMMENT '达成条件',
  `rewards` JSON DEFAULT NULL COMMENT '奖励配置',
  `rarity` ENUM('common','rare','epic','legendary') DEFAULT 'common' COMMENT '稀有度',
  `sort_order` INT DEFAULT '0' COMMENT '排序',
  `is_hidden` TINYINT(1) DEFAULT '0' COMMENT '是否隐藏',
  `is_active` TINYINT(1) DEFAULT '1' COMMENT '是否启用',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_category_type` (`category`,`type`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='成就定义表';

-- 用户成就表
CREATE TABLE `user_achievements` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `achievement_id` BIGINT UNSIGNED NOT NULL COMMENT '成就ID',
  `progress` INT DEFAULT '0' COMMENT '进度值',
  `progress_max` INT DEFAULT '100' COMMENT '最大进度',
  `unlocked_at` DATETIME DEFAULT NULL COMMENT '解锁时间',
  `viewed_at` DATETIME DEFAULT NULL COMMENT '查看时间',
  `shared_at` DATETIME DEFAULT NULL COMMENT '分享时间',
  `share_count` INT DEFAULT '0' COMMENT '分享次数',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_achievement` (`user_id`,`achievement_id`),
  KEY `idx_achievement_id` (`achievement_id`),
  KEY `idx_unlocked_at` (`unlocked_at`),
  CONSTRAINT `fk_user_achievement_achievement` FOREIGN KEY (`achievement_id`) REFERENCES `achievements` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户成就表';

-- 成就进度记录表
CREATE TABLE `achievement_progress_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `achievement_id` BIGINT UNSIGNED NOT NULL COMMENT '成就ID',
  `action` VARCHAR(50) NOT NULL COMMENT '动作标识',
  `value` INT NOT NULL DEFAULT '1' COMMENT '进度值',
  `progress_before` INT NOT NULL COMMENT '之前进度',
  `progress_after` INT NOT NULL COMMENT '之后进度',
  `source` VARCHAR(50) DEFAULT NULL COMMENT '来源',
  `source_id` VARCHAR(64) DEFAULT NULL COMMENT '来源ID',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_achievement` (`user_id`,`achievement_id`),
  KEY `idx_action` (`action`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='成就进度记录表';
```

#### 3.4.3 技能树系统表

```sql
-- 技能分类表
CREATE TABLE `skill_categories` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `code` VARCHAR(50) NOT NULL COMMENT '分类代码',
  `name` VARCHAR(100) NOT NULL COMMENT '分类名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '英文名称',
  `description` TEXT COMMENT '分类描述',
  `icon_url` VARCHAR(500) DEFAULT NULL COMMENT '图标URL',
  `sort_order` INT DEFAULT '0' COMMENT '排序',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='技能分类表';

-- 技能节点表
CREATE TABLE `skill_nodes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '节点ID',
  `category_id` BIGINT UNSIGNED NOT NULL COMMENT '分类ID',
  `parent_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '父节点ID',
  `code` VARCHAR(50) NOT NULL COMMENT '技能代码',
  `name` VARCHAR(100) NOT NULL COMMENT '技能名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '英文名称',
  `description` TEXT COMMENT '技能描述',
  `level` INT NOT NULL DEFAULT '1' COMMENT '技能等级',
  `max_level` INT NOT NULL DEFAULT '3' COMMENT '最大等级',
  `icon_url` VARCHAR(500) DEFAULT NULL COMMENT '图标URL',
  `video_url` VARCHAR(500) DEFAULT NULL COMMENT '示例视频',
  `requirements` JSON NOT NULL COMMENT '解锁要求',
  `standards` JSON NOT NULL COMMENT '达标标准',
  `points_reward` INT DEFAULT '0' COMMENT '积分奖励',
  `sort_order` INT DEFAULT '0' COMMENT '排序',
  `is_active` TINYINT(1) DEFAULT '1' COMMENT '是否启用',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code_level` (`code`,`level`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_is_active` (`is_active`),
  CONSTRAINT `fk_skill_node_category` FOREIGN KEY (`category_id`) REFERENCES `skill_categories` (`id`),
  CONSTRAINT `fk_skill_node_parent` FOREIGN KEY (`parent_id`) REFERENCES `skill_nodes` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='技能节点表';

-- 用户技能表
CREATE TABLE `user_skills` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `skill_node_id` BIGINT UNSIGNED NOT NULL COMMENT '技能节点ID',
  `current_level` INT NOT NULL DEFAULT '0' COMMENT '当前等级',
  `status` ENUM('locked','in_progress','in_review','unlocked','mastered') DEFAULT 'locked' COMMENT '状态',
  `video_url` VARCHAR(500) DEFAULT NULL COMMENT '上传视频',
  `performance_data` JSON DEFAULT NULL COMMENT '表现数据',
  `submit_time` DATETIME DEFAULT NULL COMMENT '提交时间',
  `review_time` DATETIME DEFAULT NULL COMMENT '审核时间',
  `reviewer_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '审核人ID',
  `review_notes` TEXT COMMENT '审核备注',
  `unlocked_at` DATETIME DEFAULT NULL COMMENT '解锁时间',
  `mastered_at` DATETIME DEFAULT NULL COMMENT '精通时间',
  `practice_count` INT DEFAULT '0' COMMENT '练习次数',
  `last_practice_at` DATETIME DEFAULT NULL COMMENT '最后练习时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_skill` (`user_id`,`skill_node_id`),
  KEY `idx_skill_node_id` (`skill_node_id`),
  KEY `idx_status` (`status`),
  KEY `idx_submit_time` (`submit_time`),
  CONSTRAINT `fk_user_skill_node` FOREIGN KEY (`skill_node_id`) REFERENCES `skill_nodes` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户技能表';

-- 技能审核记录表
CREATE TABLE `skill_review_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_skill_id` BIGINT UNSIGNED NOT NULL COMMENT '用户技能ID',
  `reviewer_id` BIGINT UNSIGNED NOT NULL COMMENT '审核人ID',
  `action` ENUM('approve','reject','request_info') NOT NULL COMMENT '审核动作',
  `score` INT DEFAULT NULL COMMENT '评分',
  `feedback` TEXT COMMENT '反馈内容',
  `criteria_scores` JSON DEFAULT NULL COMMENT '各项标准得分',
  `video_timestamp` JSON DEFAULT NULL COMMENT '视频时间戳标记',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_skill_id` (`user_skill_id`),
  KEY `idx_reviewer_id` (`reviewer_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_review_user_skill` FOREIGN KEY (`user_skill_id`) REFERENCES `user_skills` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='技能审核记录表';
```

### 3.5 社交模块（mobilif_social）

#### 3.5.1 社交关系表

```sql
-- 用户关系表
CREATE TABLE `user_relationships` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '关系ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_user_id` BIGINT UNSIGNED NOT NULL COMMENT '目标用户ID',
  `type` ENUM('friend','follow','block') NOT NULL COMMENT '关系类型',
  `status` ENUM('pending','accepted','rejected','cancelled') DEFAULT 'accepted' COMMENT '状态',
  `request_message` VARCHAR(200) DEFAULT NULL COMMENT '请求消息',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_relationship` (`user_id`,`target_user_id`,`type`),
  KEY `idx_target_status` (`target_user_id`,`status`),
  KEY `idx_type` (`type`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户关系表';

-- 用户群组表
CREATE TABLE `groups` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '群组ID',
  `name` VARCHAR(100) NOT NULL COMMENT '群组名称',
  `description` TEXT COMMENT '群组描述',
  `avatar_url` VARCHAR(500) DEFAULT NULL COMMENT '群组头像',
  `type` ENUM('public','private','gym','challenge') NOT NULL COMMENT '群组类型',
  `owner_id` BIGINT UNSIGNED NOT NULL COMMENT '创建者ID',
  `gym_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联场馆ID',
  `max_members` INT DEFAULT '500' COMMENT '最大成员数',
  `member_count` INT DEFAULT '0' COMMENT '当前成员数',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `settings` JSON DEFAULT NULL COMMENT '群组设置',
  `status` ENUM('active','inactive','disbanded') DEFAULT 'active' COMMENT '状态',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_owner_id` (`owner_id`),
  KEY `idx_gym_id` (`gym_id`),
  KEY `idx_type_status` (`type`,`status`),
  FULLTEXT KEY `ft_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户群组表';

-- 群组成员表
CREATE TABLE `group_members` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '成员ID',
  `group_id` BIGINT UNSIGNED NOT NULL COMMENT '群组ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `role` ENUM('owner','admin','member') DEFAULT 'member' COMMENT '角色',
  `joined_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
  `invited_by` BIGINT UNSIGNED DEFAULT NULL COMMENT '邀请人ID',
  `is_muted` TINYINT(1) DEFAULT '0' COMMENT '是否禁言',
  `muted_until` DATETIME DEFAULT NULL COMMENT '禁言到期时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_group_user` (`group_id`,`user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_role` (`role`),
  CONSTRAINT `fk_group_member_group` FOREIGN KEY (`group_id`) REFERENCES `groups` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='群组成员表';
```

#### 3.5.2 内容发布表

```sql
-- 动态表
CREATE TABLE `posts` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '动态ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `type` ENUM('workout','achievement','challenge','article','video','live') NOT NULL COMMENT '动态类型',
  `title` VARCHAR(200) DEFAULT NULL COMMENT '标题',
  `content` TEXT COMMENT '内容',
  `rich_content` JSON DEFAULT NULL COMMENT '富文本内容',
  `images` JSON DEFAULT NULL COMMENT '图片列表',
  `video_url` VARCHAR(500) DEFAULT NULL COMMENT '视频URL',
  `video_cover` VARCHAR(500) DEFAULT NULL COMMENT '视频封面',
  `video_duration` INT DEFAULT NULL COMMENT '视频时长(秒)',
  `workout_data` JSON DEFAULT NULL COMMENT '训练数据',
  `location` JSON DEFAULT NULL COMMENT '位置信息',
  `gym_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联场馆',
  `class_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联课程',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `mentions` JSON DEFAULT NULL COMMENT '@用户',
  `visibility` ENUM('public','friends','private','group') DEFAULT 'public' COMMENT '可见性',
  `group_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '群组ID(群组可见时)',
  `is_pinned` TINYINT(1) DEFAULT '0' COMMENT '是否置顶',
  `allow_comments` TINYINT(1) DEFAULT '1' COMMENT '允许评论',
  `allow_share` TINYINT(1) DEFAULT '1' COMMENT '允许分享',
  `view_count` INT DEFAULT '0' COMMENT '浏览次数',
  `like_count` INT DEFAULT '0' COMMENT '点赞数',
  `comment_count` INT DEFAULT '0' COMMENT '评论数',
  `share_count` INT DEFAULT '0' COMMENT '分享数',
  `save_count` INT DEFAULT '0' COMMENT '收藏数',
  `status` ENUM('draft','published','hidden','deleted') DEFAULT 'published' COMMENT '状态',
  `published_at` DATETIME DEFAULT NULL COMMENT '发布时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_type` (`user_id`,`type`),
  KEY `idx_visibility_status` (`visibility`,`status`),
  KEY `idx_gym_id` (`gym_id`),
  KEY `idx_published_at` (`published_at`),
  FULLTEXT KEY `ft_content` (`title`,`content`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='动态表';

-- 评论表
CREATE TABLE `comments` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '评论ID',
  `post_id` BIGINT UNSIGNED NOT NULL COMMENT '动态ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `parent_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '父评论ID',
  `content` TEXT NOT NULL COMMENT '评论内容',
  `images` JSON DEFAULT NULL COMMENT '图片',
  `mentions` JSON DEFAULT NULL COMMENT '@用户',
  `like_count` INT DEFAULT '0' COMMENT '点赞数',
  `reply_count` INT DEFAULT '0' COMMENT '回复数',
  `is_pinned` TINYINT(1) DEFAULT '0' COMMENT '是否置顶',
  `status` ENUM('normal','hidden','deleted') DEFAULT 'normal' COMMENT '状态',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_post_id` (`post_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_comment_post` FOREIGN KEY (`post_id`) REFERENCES `posts` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';

-- 点赞表
CREATE TABLE `likes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '点赞ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_type` ENUM('post','comment','user') NOT NULL COMMENT '目标类型',
  `target_id` BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`,`target_type`,`target_id`),
  KEY `idx_target` (`target_type`,`target_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞表';

-- 收藏表
CREATE TABLE `favorites` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `target_type` ENUM('post','gym','class','workout') NOT NULL COMMENT '目标类型',
  `target_id` BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
  `folder_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '收藏夹ID',
  `tags` JSON DEFAULT NULL COMMENT '标签',
  `note` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`,`target_type`,`target_id`),
  KEY `idx_folder_id` (`folder_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='收藏表';
```

### 3.6 内容模块（mobilif_content）

#### 3.6.1 训练内容表

```sql
-- WOD库表
CREATE TABLE `wod_library` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'WOD ID',
  `name` VARCHAR(100) NOT NULL COMMENT 'WOD名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '英文名称',
  `type` ENUM('hero','girl','benchmark','custom','open') NOT NULL COMMENT 'WOD类型',
  `category` ENUM('amrap','ft','emom','tabata','chipper','ladder') NOT NULL COMMENT '训练类别',
  `description` TEXT COMMENT '描述',
  `description_en` TEXT COMMENT '英文描述',
  `movements` JSON NOT NULL COMMENT '动作列表',
  `time_cap` INT DEFAULT NULL COMMENT '时间上限(分钟)',
  `rounds` INT DEFAULT NULL COMMENT '轮数',
  `difficulty_level` ENUM('beginner','intermediate','advanced','rx','rx+') DEFAULT 'intermediate' COMMENT '难度等级',
  `equipment_needed` JSON DEFAULT NULL COMMENT '所需器械',
  `scaling_options` JSON DEFAULT NULL COMMENT '缩放选项',
  `tips` TEXT COMMENT '训练建议',
  `video_url` VARCHAR(500) DEFAULT NULL COMMENT '示例视频',
  `created_by` BIGINT UNSIGNED DEFAULT NULL COMMENT '创建者',
  `is_official` TINYINT(1) DEFAULT '0' COMMENT '是否官方',
  `usage_count` INT DEFAULT '0' COMMENT '使用次数',
  `avg_score` DECIMAL(10,2) DEFAULT NULL COMMENT '平均成绩',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_type_category` (`type`,`category`),
  KEY `idx_difficulty` (`difficulty_level`),
  KEY `idx_created_by` (`created_by`),
  FULLTEXT KEY `ft_name` (`name`,`name_en`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='WOD库表';

-- 动作库表
CREATE TABLE `movement_library` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '动作ID',
  `code` VARCHAR(50) NOT NULL COMMENT '动作代码',
  `name` VARCHAR(100) NOT NULL COMMENT '动作名称',
  `name_en` VARCHAR(100) DEFAULT NULL COMMENT '英文名称',
  `category` ENUM('weightlifting','gymnastics','monostructural','strongman') NOT NULL COMMENT '动作类别',
  `muscle_groups` JSON DEFAULT NULL COMMENT '肌肉群',
  `description` TEXT COMMENT '动作描述',
  `technique_points` JSON DEFAULT NULL COMMENT '技术要点',
  `common_faults` JSON DEFAULT NULL COMMENT '常见错误',
  `progressions` JSON DEFAULT NULL COMMENT '进阶步骤',
  `scaling_options` JSON DEFAULT NULL COMMENT '缩放选项',
  `demo_video_url` VARCHAR(500) DEFAULT NULL COMMENT '示范视频',
  `images` JSON DEFAULT NULL COMMENT '动作图解',
  `equipment_needed` JSON DEFAULT NULL COMMENT '所需器械',
  `safety_tips` TEXT COMMENT '安全提示',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`),
  KEY `idx_category` (`category`),
  FULLTEXT KEY `ft_name` (`name`,`name_en`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='动作库表';

-- 训练计划模板表
CREATE TABLE `training_plan_templates` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `name` VARCHAR(100) NOT NULL COMMENT '计划名称',
  `description` TEXT COMMENT '计划描述',
  `goal` ENUM('strength','endurance','skill','weight_loss','muscle_gain','general') NOT NULL COMMENT '训练目标',
  `duration_weeks` INT NOT NULL COMMENT '持续周数',
  `frequency_per_week` INT NOT NULL COMMENT '每周频率',
  `level` ENUM('beginner','intermediate','advanced') NOT NULL COMMENT '适用等级',
  `structure` JSON NOT NULL COMMENT '计划结构',
  `created_by` BIGINT UNSIGNED DEFAULT NULL COMMENT '创建者',
  `is_official` TINYINT(1) DEFAULT '0' COMMENT '是否官方',
  `usage_count` INT DEFAULT '0' COMMENT '使用次数',
  `rating` DECIMAL(2,1) DEFAULT '0.0' COMMENT '评分',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_goal_level` (`goal`,`level`),
  KEY `idx_created_by` (`created_by`),
  FULLTEXT KEY `ft_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='训练计划模板表';
```

### 3.7 数据分析模块（mobilif_analytics）

#### 3.7.1 用户行为分析表

```sql
-- 用户训练记录表
CREATE TABLE `workout_records` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `class_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '课程ID',
  `gym_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '场馆ID',
  `wod_id` BIGINT UNSIGNED DEFAULT NULL COMMENT 'WOD ID',
  `workout_date` DATE NOT NULL COMMENT '训练日期',
  `start_time` DATETIME NOT NULL COMMENT '开始时间',
  `end_time` DATETIME NOT NULL COMMENT '结束时间',
  `duration_minutes` INT NOT NULL COMMENT '时长(分钟)',
  `type` VARCHAR(50) NOT NULL COMMENT '训练类型',
  `intensity_level` ENUM('low','moderate','high','max') DEFAULT 'moderate' COMMENT '强度等级',
  `workout_data` JSON NOT NULL COMMENT '训练数据',
  `movements` JSON DEFAULT NULL COMMENT '动作列表',
  `scores` JSON DEFAULT NULL COMMENT '成绩数据',
  `calories_burned` INT DEFAULT NULL COMMENT '消耗卡路里',
  `heart_rate_avg` INT DEFAULT NULL COMMENT '平均心率',
  `heart_rate_max` INT DEFAULT NULL COMMENT '最大心率',
  `notes` TEXT COMMENT '训练笔记',
  `feeling` ENUM('great','good','ok','tired','exhausted') DEFAULT NULL COMMENT '训练感受',
  `pr_records` JSON DEFAULT NULL COMMENT 'PR记录',
  `injuries` JSON DEFAULT NULL COMMENT '受伤记录',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_date` (`user_id`,`workout_date`),
  KEY `idx_class_id` (`class_id`),
  KEY `idx_gym_id` (`gym_id`),
  KEY `idx_wod_id` (`wod_id`),
  KEY `idx_workout_date` (`workout_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户训练记录表';

-- PR记录表
CREATE TABLE `pr_records` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `movement_id` BIGINT UNSIGNED NOT NULL COMMENT '动作ID',
  `record_type` ENUM('weight','reps','time','distance') NOT NULL COMMENT '记录类型',
  `value` DECIMAL(10,2) NOT NULL COMMENT '记录值',
  `unit` VARCHAR(20) NOT NULL COMMENT '单位',
  `previous_value` DECIMAL(10,2) DEFAULT NULL COMMENT '之前记录',
  `improvement` DECIMAL(10,2) DEFAULT NULL COMMENT '提升幅度',
  `workout_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '训练记录ID',
  `video_url` VARCHAR(500) DEFAULT NULL COMMENT '视频证明',
  `verified` TINYINT(1) DEFAULT '0' COMMENT '是否验证',
  `achieved_at` DATE NOT NULL COMMENT '达成日期',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_movement` (`user_id`,`movement_id`),
  KEY `idx_achieved_at` (`achieved_at`),
  CONSTRAINT `fk_pr_workout` FOREIGN KEY (`workout_id`) REFERENCES `workout_records` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='PR记录表';

-- 用户活跃度统计表
CREATE TABLE `user_activity_stats` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '统计ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `stat_date` DATE NOT NULL COMMENT '统计日期',
  `login_count` INT DEFAULT '0' COMMENT '登录次数',
  `workout_count` INT DEFAULT '0' COMMENT '训练次数',
  `workout_minutes` INT DEFAULT '0' COMMENT '训练时长',
  `booking_count` INT DEFAULT '0' COMMENT '预约次数',
  `social_actions` INT DEFAULT '0' COMMENT '社交互动数',
  `points_earned` INT DEFAULT '0' COMMENT '获得积分',
  `points_spent` INT DEFAULT '0' COMMENT '消费积分',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_date` (`user_id`,`stat_date`),
  KEY `idx_stat_date` (`stat_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户活跃度统计表';
```

## 4. 索引设计策略

### 4.1 索引设计原则
1. **选择性原则**: 优先为选择性高的列创建索引
2. **最左前缀原则**: 复合索引遵循最左前缀匹配
3. **覆盖索引**: 尽可能使用覆盖索引减少回表
4. **避免冗余**: 避免创建冗余和重复的索引

### 4.2 核心查询索引设计

```sql
-- 用户登录查询优化
ALTER TABLE users ADD INDEX idx_phone_status (phone, status);
ALTER TABLE user_auth ADD INDEX idx_identifier_type (identifier, auth_type);

-- 场馆搜索优化（地理位置查询）
ALTER TABLE gyms ADD SPATIAL INDEX idx_location (point);
ALTER TABLE gyms ADD INDEX idx_city_rating_status (city, rating DESC, status);

-- 课程查询优化
ALTER TABLE classes ADD INDEX idx_gym_start_status (gym_id, start_time, status);
ALTER TABLE classes ADD INDEX idx_start_type_status (start_time, type, status);

-- 预约查询优化
ALTER TABLE bookings ADD INDEX idx_user_created_status (user_id, created_at DESC, status);
ALTER TABLE bookings ADD INDEX idx_class_status (class_id, status);

-- 积分查询优化
ALTER TABLE point_transactions ADD INDEX idx_user_created (user_id, created_at DESC);
ALTER TABLE user_points ADD INDEX idx_user_level (user_id, level);

-- 社交查询优化
ALTER TABLE posts ADD INDEX idx_user_published_visibility (user_id, published_at DESC, visibility);
ALTER TABLE user_relationships ADD INDEX idx_user_type_status (user_id, type, status);
```

## 5. 数据分区策略

### 5.1 分区设计

```sql
-- 预约订单表按月分区
ALTER TABLE bookings PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    -- ... 更多分区
    PARTITION p_max VALUES LESS THAN MAXVALUE
);

-- 训练记录表按月分区
ALTER TABLE workout_records PARTITION BY RANGE (TO_DAYS(workout_date)) (
    PARTITION p202401 VALUES LESS THAN (TO_DAYS('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (TO_DAYS('2024-03-01')),
    PARTITION p202403 VALUES LESS THAN (TO_DAYS('2024-04-01')),
    -- ... 更多分区
    PARTITION p_max VALUES LESS THAN MAXVALUE
);

-- 积分流水表按季度分区
ALTER TABLE point_transactions PARTITION BY RANGE (UNIX_TIMESTAMP(created_at)) (
    PARTITION p2024q1 VALUES LESS THAN (UNIX_TIMESTAMP('2024-04-01')),
    PARTITION p2024q2 VALUES LESS THAN (UNIX_TIMESTAMP('2024-07-01')),
    PARTITION p2024q3 VALUES LESS THAN (UNIX_TIMESTAMP('2024-10-01')),
    PARTITION p2024q4 VALUES LESS THAN (UNIX_TIMESTAMP('2025-01-01')),
    PARTITION p_max VALUES LESS THAN MAXVALUE
);
```

## 6. 数据库优化建议

### 6.1 查询优化
1. 使用 EXPLAIN 分析慢查询
2. 避免 SELECT *，指定需要的列
3. 合理使用 JOIN，避免笛卡尔积
4. 使用预编译语句防止 SQL 注入

### 6.2 表结构优化
1. 选择合适的数据类型，避免过度设计
2. 合理使用 NULL，尽量 NOT NULL
3. 规范化与反规范化的权衡
4. 定期维护表结构和索引

### 6.3 存储优化
1. 定期清理历史数据
2. 使用压缩技术节省空间
3. 冷热数据分离存储
4. 合理设置表和索引的存储参数

### 6.4 备份策略
1. 全量备份：每周一次
2. 增量备份：每天一次
3. 二进制日志：实时备份
4. 异地备份：防止灾难性故障

## 7. 数据迁移方案

### 7.1 版本管理
- 使用 Flyway 或 Liquibase 进行数据库版本管理
- 所有 DDL 变更必须有对应的迁移脚本
- 支持回滚机制

### 7.2 迁移流程
1. 开发环境验证
2. 测试环境执行
3. 预生产环境确认
4. 生产环境实施
5. 数据一致性校验

## 8. 监控与维护

### 8.1 监控指标
- QPS（每秒查询数）
- TPS（每秒事务数）
- 慢查询数量
- 连接数使用率
- 缓冲池命中率
- 磁盘IO使用率

### 8.2 定期维护
- 每周分析慢查询日志
- 每月检查索引使用情况
- 每季度评估分区策略
- 每年进行容量规划

## 9. 安全策略

### 9.1 访问控制
- 最小权限原则
- 定期轮换密码
- IP白名单限制
- SSL/TLS加密连接

### 9.2 数据安全
- 敏感数据加密存储
- 定期安全审计
- 数据脱敏处理
- 防SQL注入措施

## 10. 总结

本数据库设计文档为MobiLiF拓练平台提供了完整的数据存储方案，涵盖了用户、场馆、订单、游戏化、社交等核心业务模块。通过合理的表结构设计、索引优化、分区策略等技术手段，确保系统能够支撑百万级用户规模的高并发访问需求，为产品的快速发展提供坚实的数据基础。